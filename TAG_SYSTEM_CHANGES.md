# –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ —Ç–µ–≥–æ–≤

## –û–±–∑–æ—Ä
–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–µ–≥–æ–≤ –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–æ—Ç–µ.

## –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

### SQL —Å–∫—Ä–∏–ø—Ç—ã
- `add_tag_system.sql` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è —Ç–µ–≥–∞ –∏ –±–∞–∑–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- `update_functions_with_tags.sql` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–≥–∞–º–∏
- `cleanup_functions.sql` - –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- `test_tag_system.sql` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `INSTALL_TAG_SYSTEM.md` - –ø–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
- `QUICK_INSTALL_TAGS.md` - –±—ã—Å—Ç—Ä–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- `TAG_SYSTEM_CHANGES.md` - —ç—Ç–æ—Ç —Ñ–∞–π–ª

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### database/db.py
–î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏:
- `update_user_tag(user_id, new_tag)` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `get_user_by_tag(tag)` - –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ç–µ–≥—É
- `is_tag_available(tag, exclude_user_id)` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–µ–≥–∞
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ `create_user()` - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ–≥–∞

### handlers/chat_commands.py
–û–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã:
- `/me` - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–≥ –≤–º–µ—Å—Ç–æ –∏–º–µ–Ω–∏
- `/top`, `/topm`, `/topw`, `/topd` - –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ç–µ–≥–∏ –≤ —Ç–æ–ø–∞—Ö
- `/kasa` - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–≥–∏ –≤ —Ç–æ–ø-5
- `/analytics` - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–≥–∏ –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ

–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞:
- `/changetag –Ω–æ–≤—ã–π_—Ç–µ–≥` - —Å–º–µ–Ω–∞ —Ç–µ–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### handlers/user_menu.py
–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è:
- `_build_profile_text()` - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–≥ –≤ –ø—Ä–æ—Ñ–∏–ª–µ

### handlers/admin_manage.py
–û–±–Ω–æ–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏:
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–≥–æ–≤ –≤ —Å–ø–∏—Å–∫–∞—Ö –≤—ã–ø–ª–∞—Ç
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–≥–æ–≤ –≤ —Ç–æ–ø–∞—Ö –∞–¥–º–∏–Ω–∫–∏

### database/__init__.py
–î–æ–±–∞–≤–ª–µ–Ω—ã —ç–∫—Å–ø–æ—Ä—Ç—ã:
- `update_user_tag`
- `get_user_by_tag`
- `is_tag_available`

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ users
–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ:
- `user_tag TEXT UNIQUE` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–µ–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `generate_next_tag()` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç–µ–≥–∞
- `assign_user_tag()` - —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∞–≤—Ç–æ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ç–µ–≥–∞

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `get_top_workers()` - —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç user_tag
- `get_user_position()` - —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç user_tag
- `get_unpaid_profits_summary()` - —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç user_tag
- `get_unpaid_referral_summary()` - —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç referrer_tag
- `get_unpaid_mentor_summary()` - —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç mentor_tag

### –ù–æ–≤—ã–µ views
- `profits_with_tags` - –ø—Ä–æ—Ñ–∏—Ç—ã —Å —Ç–µ–≥–∞–º–∏
- `mentor_details` - –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–≥–æ–≤

## –ù–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

### /changetag
–°–º–µ–Ω–∞ —Ç–µ–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```
/changetag #new_tag
```

**–ü—Ä–∞–≤–∏–ª–∞:**
- –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å #
- –î–ª–∏–Ω–∞ 3-20 —Å–∏–º–≤–æ–ª–æ–≤
- –¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, _
- –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º

**–ü—Ä–∏–º–µ—Ä—ã:**
```
/changetag #irl_boss
/changetag #worker1
/changetag #pro_trader
```

## –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### /me
–¢–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
```
üè∑ #irl_1

üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ñ–∏–ª–µ:
...
üîß –°–º–µ–Ω–∏—Ç—å —Ç–µ–≥: /changetag –Ω–æ–≤—ã–π_—Ç–µ–≥
```

### /top, /topm, /topw, /topd
–¢–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç:
```
ü•á #irl_1
   üí∞ 1000.00 RUB ‚Ä¢ 10 —à—Ç
ü•à #irl_2
   üí∞ 800.00 RUB ‚Ä¢ 8 —à—Ç
```

### /help
–î–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞:
```
üè∑ /changetag - –°–º–µ–Ω–∏—Ç—å —Ç–µ–≥
```

## –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ `add_tag_system.sql` –≤—Å–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–∞—é—Ç—Å—è —Ç–µ–≥–∏ –≤ –ø–æ—Ä—è–¥–∫–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:
- –ü–µ—Ä–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí #irl_1
- –í—Ç–æ—Ä–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí #irl_2
- –ò —Ç–∞–∫ –¥–∞–ª–µ–µ...

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –¢–µ–≥–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã (UNIQUE constraint)
- –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–æ—Ç–∞ (regex)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ —Å–º–µ–Ω–æ–π
- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –î–æ–±–∞–≤–ª–µ–Ω –∏–Ω–¥–µ–∫—Å –Ω–∞ user_tag
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤

## –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–í—Å–µ —Å—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å:
- username –∏ full_name –æ—Å—Ç–∞—é—Ç—Å—è –≤ –±–∞–∑–µ
- –ê–¥–º–∏–Ω—ã –≤–∏–¥—è—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- –ú–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

## –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º–µ:

```sql
-- –£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ —Ç–µ–≥–∞
ALTER TABLE users DROP COLUMN IF EXISTS user_tag;

-- –£–¥–∞–ª–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏
DROP FUNCTION IF EXISTS generate_next_tag();
DROP FUNCTION IF EXISTS assign_user_tag();
DROP TRIGGER IF EXISTS trigger_assign_user_tag ON users;

-- –û—Ç–∫–∞—Ç–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ (–≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ –∏–∑ supabase_functions.sql)
```

–ó–∞—Ç–µ–º –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ —á–µ—Ä–µ–∑ git.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—ã–ø–æ–ª–Ω–∏—Ç–µ `test_tag_system.sql` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
1. –ù–∞–ª–∏—á–∏–µ –ø–æ–ª—è user_tag
2. –†–∞–±–æ—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
3. –ù–∞–ª–∏—á–∏–µ —Ç–µ–≥–æ–≤ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
4. –†–∞–±–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
5. –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Ç–µ–≥–æ–≤