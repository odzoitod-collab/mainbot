<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IRL Team • Профиты</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-secondary-bg-color: #f4f4f5;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #8e8e93;
            --tg-theme-link-color: #2AABEE;
            --tg-theme-button-color: #2AABEE;
            --tg-theme-button-text-color: #ffffff;
        }
        :root {
            --bg: var(--tg-theme-bg-color);
            --bg2: var(--tg-theme-secondary-bg-color);
            --text: var(--tg-theme-text-color);
            --hint: var(--tg-theme-hint-color);
            --accent: var(--tg-theme-button-color);
            --accent-light: rgba(42, 171, 238, 0.12);
            --btn-text: var(--tg-theme-button-text-color);
            --green: #34C759;
            --green-light: rgba(52, 199, 89, 0.12);
            --orange: #FF9500;
            --orange-light: rgba(255, 149, 0, 0.12);
            --purple: #AF52DE;
            --purple-light: rgba(175, 82, 222, 0.12);
            --radius: 16px;
            --radius-sm: 12px;
            --shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif; background: var(--bg2); color: var(--text); min-height: 100vh; padding-bottom: 40px; }
    </style>
</head>
<body>
    <div class="header" id="header"></div>
    <div class="stats-card" id="statsCard"></div>
    <div class="quick-stats" id="quickStats"></div>
    <div class="section"><div class="section-title">История начислений</div><div id="content"></div></div>
    <div class="modal-overlay" id="modal"><div class="modal"><div class="modal-handle"></div><div class="modal-header"><div class="modal-title">Детали профита</div></div><div class="modal-body" id="modalBody"></div></div></div>
    <div class="loader" id="loader"><div class="spinner"></div><div class="loader-text">Загрузка...</div></div>
</body>
</html>

<style>
    /* Header */
    .header { background: var(--bg); padding: 16px 20px; display: flex; align-items: center; gap: 14px; border-bottom: 1px solid var(--bg2); }
    .header-avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, var(--purple), #8B5CF6); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; }
    .header-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .header-avatar svg { width: 24px; height: 24px; color: #fff; }
    .header-info { flex: 1; min-width: 0; }
    .header-title { font-size: 18px; font-weight: 600; }
    .header-sub { font-size: 13px; color: var(--hint); margin-top: 2px; display: flex; align-items: center; gap: 6px; }
    .header-badge { background: var(--purple-light); color: var(--purple); padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
    
    /* Stats Card */
    .stats-card { background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 50%, #A855F7 100%); margin: 16px; border-radius: var(--radius); padding: 24px 20px; color: #fff; position: relative; overflow: hidden; box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3); }
    .stats-card::before { content: ''; position: absolute; top: -60%; right: -20%; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%; }
    .stats-card::after { content: ''; position: absolute; bottom: -40%; left: -10%; width: 150px; height: 150px; background: rgba(255,255,255,0.05); border-radius: 50%; }
    .stats-label { font-size: 14px; opacity: 0.9; display: flex; align-items: center; gap: 8px; }
    .stats-label svg { width: 18px; height: 18px; }
    .stats-amount { font-size: 40px; font-weight: 700; margin: 8px 0; letter-spacing: -1px; }
    .stats-row { display: flex; gap: 16px; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); }
    .stats-item { flex: 1; text-align: center; }
    .stats-item-val { font-size: 20px; font-weight: 600; }
    .stats-item-lbl { font-size: 12px; opacity: 0.8; margin-top: 4px; }
    
    /* Quick Stats */
    .quick-stats { display: flex; gap: 12px; padding: 0 16px; margin-bottom: 8px; overflow-x: auto; scrollbar-width: none; }
    .quick-stats::-webkit-scrollbar { display: none; }
    .quick-stat { background: var(--bg); border-radius: var(--radius-sm); padding: 14px 16px; min-width: 120px; flex-shrink: 0; box-shadow: var(--shadow); }
    .quick-stat-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
    .quick-stat-icon svg { width: 20px; height: 20px; }
    .quick-stat-icon.green { background: var(--green-light); color: var(--green); }
    .quick-stat-icon.orange { background: var(--orange-light); color: var(--orange); }
    .quick-stat-icon.purple { background: var(--purple-light); color: var(--purple); }
    .quick-stat-val { font-size: 18px; font-weight: 700; }
    .quick-stat-lbl { font-size: 12px; color: var(--hint); margin-top: 2px; }
</style>

<style>
    /* Section */
    .section { padding: 0 16px; }
    .section-title { font-size: 13px; color: var(--hint); text-transform: uppercase; letter-spacing: 0.5px; margin: 20px 0 12px 4px; font-weight: 600; }
    
    /* List */
    .list { background: var(--bg); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); }
    .list-item { display: flex; align-items: center; padding: 14px 16px; gap: 12px; cursor: pointer; transition: background 0.15s; }
    .list-item:active { background: var(--bg2); }
    .list-item:not(:last-child) { border-bottom: 1px solid var(--bg2); }
    
    .item-icon { width: 46px; height: 46px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .item-icon svg { width: 24px; height: 24px; }
    .item-icon.paid { background: var(--green-light); color: var(--green); }
    .item-icon.hold { background: var(--orange-light); color: var(--orange); }
    
    .item-content { flex: 1; min-width: 0; }
    .item-title { font-size: 16px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-sub { font-size: 13px; color: var(--hint); margin-top: 3px; display: flex; align-items: center; gap: 6px; }
    
    .item-right { text-align: right; }
    .item-amount { font-size: 17px; font-weight: 600; color: var(--green); }
    .item-status { font-size: 11px; padding: 4px 10px; border-radius: 8px; margin-top: 4px; display: inline-block; font-weight: 500; }
    .item-status.paid { background: var(--green-light); color: var(--green); }
    .item-status.hold { background: var(--orange-light); color: var(--orange); }
    
    /* Empty */
    .empty { text-align: center; padding: 60px 20px; }
    .empty-icon { width: 80px; height: 80px; margin: 0 auto 20px; background: var(--bg2); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .empty-icon svg { width: 40px; height: 40px; color: var(--hint); }
    .empty-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .empty-text { font-size: 14px; color: var(--hint); max-width: 260px; margin: 0 auto; line-height: 1.5; }
</style>

<style>
    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; opacity: 0; visibility: hidden; transition: all 0.25s; backdrop-filter: blur(4px); }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal { position: fixed; bottom: 0; left: 0; right: 0; max-height: 80vh; background: var(--bg); border-radius: 24px 24px 0 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1); overflow: hidden; display: flex; flex-direction: column; }
    .modal-overlay.active .modal { transform: translateY(0); }
    .modal-handle { width: 36px; height: 4px; background: var(--hint); opacity: 0.3; border-radius: 2px; margin: 12px auto 8px; flex-shrink: 0; }
    .modal-header { padding: 8px 20px 16px; text-align: center; border-bottom: 1px solid var(--bg2); }
    .modal-title { font-size: 18px; font-weight: 600; }
    .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
    
    .detail-amount { text-align: center; padding: 20px 0 24px; }
    .detail-amount-label { font-size: 14px; color: var(--hint); margin-bottom: 8px; }
    .detail-amount-value { font-size: 44px; font-weight: 700; color: var(--green); }
    
    .detail-card { background: var(--bg2); border-radius: var(--radius-sm); overflow: hidden; }
    .detail-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; }
    .detail-row:not(:last-child) { border-bottom: 1px solid var(--bg); }
    .detail-label { font-size: 15px; color: var(--hint); display: flex; align-items: center; gap: 8px; }
    .detail-label svg { width: 18px; height: 18px; }
    .detail-value { font-size: 15px; font-weight: 500; text-align: right; max-width: 55%; }
    
    /* Loader */
    .loader { position: fixed; inset: 0; background: var(--bg); z-index: 200; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 16px; }
    .loader.hidden { display: none; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--bg2); border-top-color: var(--purple); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loader-text { font-size: 15px; color: var(--hint); }
</style>

<script>
    // SVG Icons
    const ICONS = {
        diamond: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2.7 10.3a2.41 2.41 0 0 0 0 3.41l7.59 7.59a2.41 2.41 0 0 0 3.41 0l7.59-7.59a2.41 2.41 0 0 0 0-3.41l-7.59-7.59a2.41 2.41 0 0 0-3.41 0Z"/></svg>',
        wallet: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>',
        check: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6 9 17l-5-5"/></svg>',
        clock: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
        calendar: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg>',
        tag: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></svg>',
        percent: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>',
        hash: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/><line x1="10" y1="3" x2="8" y2="21"/><line x1="16" y1="3" x2="14" y2="21"/></svg>',
        trending: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>',
        inbox: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>'
    };
    
    const SUPABASE_URL = 'https://aoyctqguudkdwgixlmvr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFveWN0cWd1dWRrZHdnaXhsbXZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMjU0MDIsImV4cCI6MjA4MTkwMTQwMn0.AOpN7RldZ29C9fP41eMmAb66Jy9bnYwez3FT9V4qV5U';
    
    let db, tg, userId, userPhoto, userName;
    try { db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) {}
    try { 
        tg = window.Telegram?.WebApp; 
        if(tg) { 
            tg.ready(); 
            tg.expand(); 
            userId = tg.initDataUnsafe?.user?.id;
            userPhoto = tg.initDataUnsafe?.user?.photo_url;
            userName = tg.initDataUnsafe?.user?.first_name || 'Пользователь';
        } 
    } catch(e) {}
    
    const fmt = n => new Intl.NumberFormat('ru-RU').format(Math.round(n)) + ' ₽';
    const fmtDate = d => {
        const date = new Date(d), now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const time = date.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'});
        if (dateOnly.getTime() === today.getTime()) return `Сегодня, ${time}`;
        const yesterday = new Date(today); yesterday.setDate(yesterday.getDate()-1);
        if (dateOnly.getTime() === yesterday.getTime()) return `Вчера, ${time}`;
        return date.toLocaleDateString('ru-RU', {day:'numeric', month:'short'}) + `, ${time}`;
    };
    const fmtFull = d => new Date(d).toLocaleDateString('ru-RU', {day:'numeric', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit'});
</script>

<script>
    async function load() {
        if (!userId || !db) { 
            document.getElementById('content').innerHTML = `<div class="empty"><div class="empty-icon">${ICONS.inbox}</div><div class="empty-title">Ошибка доступа</div><div class="empty-text">Откройте страницу через Telegram бота</div></div>`; 
            document.getElementById('loader').classList.add('hidden'); 
            return; 
        }
        
        const [profitsRes, userRes] = await Promise.all([
            db.from('profits').select('*').eq('worker_id', userId).order('created_at', {ascending: false}),
            db.from('users').select('*').eq('id', userId).single()
        ]);
        
        document.getElementById('loader').classList.add('hidden');
        
        const data = profitsRes.data || [];
        const user = userRes.data;
        
        // Header
        const avatarHtml = userPhoto ? `<img src="${userPhoto}" alt="">` : ICONS.diamond;
        document.getElementById('header').innerHTML = `
            <div class="header-avatar">${avatarHtml}</div>
            <div class="header-info">
                <div class="header-title">${user?.full_name || userName}</div>
                <div class="header-sub">
                    <span>${data.length} профитов</span>
                    <span class="header-badge">История</span>
                </div>
            </div>
        `;
        
        if (!data.length) { 
            document.getElementById('statsCard').style.display = 'none';
            document.getElementById('quickStats').style.display = 'none';
            document.getElementById('content').innerHTML = `<div class="empty"><div class="empty-icon">${ICONS.inbox}</div><div class="empty-title">Пока пусто</div><div class="empty-text">Здесь появится история ваших профитов после первого заработка</div></div>`; 
            return; 
        }
        
        const total = data.reduce((s,p) => s + parseFloat(p.net_profit), 0);
        const paid = data.filter(p => p.status === 'paid');
        const hold = data.filter(p => p.status === 'hold');
        const holdSum = hold.reduce((s,p) => s + parseFloat(p.net_profit), 0);
        const avgProfit = total / data.length;
        const maxProfit = Math.max(...data.map(p => parseFloat(p.net_profit)));
        
        // Stats Card
        document.getElementById('statsCard').innerHTML = `
            <div class="stats-label">${ICONS.wallet} Общий заработок</div>
            <div class="stats-amount">${fmt(total)}</div>
            <div class="stats-row">
                <div class="stats-item">
                    <div class="stats-item-val">${paid.length}</div>
                    <div class="stats-item-lbl">Выплачено</div>
                </div>
                <div class="stats-item">
                    <div class="stats-item-val">${hold.length}</div>
                    <div class="stats-item-lbl">На холде</div>
                </div>
                <div class="stats-item">
                    <div class="stats-item-val">${fmt(holdSum)}</div>
                    <div class="stats-item-lbl">К выплате</div>
                </div>
            </div>
        `;
        
        // Quick Stats
        document.getElementById('quickStats').innerHTML = `
            <div class="quick-stat">
                <div class="quick-stat-icon green">${ICONS.trending}</div>
                <div class="quick-stat-val">${fmt(avgProfit)}</div>
                <div class="quick-stat-lbl">Средний профит</div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-icon orange">${ICONS.diamond}</div>
                <div class="quick-stat-val">${fmt(maxProfit)}</div>
                <div class="quick-stat-lbl">Макс. профит</div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-icon purple">${ICONS.calendar}</div>
                <div class="quick-stat-val">${data.length}</div>
                <div class="quick-stat-lbl">Всего профитов</div>
            </div>
        `;
        
        // List
        document.getElementById('content').innerHTML = `<div class="list">${data.map(p => `
            <div class="list-item" onclick='showDetail(${JSON.stringify(p).replace(/'/g,"&#39;")})'>
                <div class="item-icon ${p.status}">${p.status === 'paid' ? ICONS.check : ICONS.clock}</div>
                <div class="item-content">
                    <div class="item-title">${p.service_name}</div>
                    <div class="item-sub">${ICONS.calendar} ${fmtDate(p.created_at)}</div>
                </div>
                <div class="item-right">
                    <div class="item-amount">+${fmt(p.net_profit)}</div>
                    <div class="item-status ${p.status}">${p.status === 'paid' ? 'Выплачено' : 'Холд'}</div>
                </div>
            </div>
        `).join('')}</div>`;
    }
    
    function showDetail(p) {
        const pct = p.amount > 0 ? Math.round((p.net_profit / p.amount) * 100) : 0;
        document.getElementById('modalBody').innerHTML = `
            <div class="detail-amount">
                <div class="detail-amount-label">К выплате</div>
                <div class="detail-amount-value">+${fmt(p.net_profit)}</div>
            </div>
            <div class="detail-card">
                <div class="detail-row"><span class="detail-label">${ICONS.hash} ID</span><span class="detail-value">#${p.id}</span></div>
                <div class="detail-row"><span class="detail-label">${ICONS.tag} Сервис</span><span class="detail-value">${p.service_name}</span></div>
                <div class="detail-row"><span class="detail-label">${ICONS.wallet} Общая сумма</span><span class="detail-value">${fmt(p.amount)}</span></div>
                <div class="detail-row"><span class="detail-label">${ICONS.percent} Ваш процент</span><span class="detail-value">${pct}%</span></div>
                <div class="detail-row"><span class="detail-label">${ICONS.clock} Статус</span><span class="detail-value">${p.status === 'paid' ? '✅ Выплачено' : '⏳ На холде'}</span></div>
                <div class="detail-row"><span class="detail-label">${ICONS.calendar} Создан</span><span class="detail-value">${fmtFull(p.created_at)}</span></div>
                ${p.paid_at ? `<div class="detail-row"><span class="detail-label">${ICONS.check} Выплачен</span><span class="detail-value">${fmtFull(p.paid_at)}</span></div>` : ''}
            </div>
        `;
        document.getElementById('modal').classList.add('active');
    }
    
    document.getElementById('modal').onclick = e => { if(e.target.id === 'modal') document.getElementById('modal').classList.remove('active'); };
    if(tg?.BackButton) { tg.BackButton.onClick(() => document.getElementById('modal').classList.remove('active')); }
    
    load();
</script>