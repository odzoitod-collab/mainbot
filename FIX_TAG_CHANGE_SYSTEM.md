# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Å–º–µ–Ω—ã —Ç–µ–≥–æ–≤

## –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:

### 1. –ö–Ω–æ–ø–∫–∞ "–°–º–µ–Ω–∏—Ç—å —Ç–µ–≥" –Ω–µ –Ω–∞–∂–∏–º–∞–ª–∞—Å—å
**–ü—Ä–∏—á–∏–Ω–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ parse_mode –≤ callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω `parse_mode="HTML"` –≤–æ –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å try-except –±–ª–æ–∫–∞–º–∏
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –ò–∑–º–µ–Ω–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –∫ –ø—Ä–æ—Ñ–∏–ª—é" –Ω–∞ `callback_data="profile"` –≤–º–µ—Å—Ç–æ `"back_to_profile"`

### 2. –ü–æ—Å–ª–µ –≤–≤–æ–¥–∞ –Ω–æ–≤–æ–≥–æ —Ç–µ–≥–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ
**–ü—Ä–∏—á–∏–Ω–∞:** FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–æ—Å—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `process_new_tag`
- –£–ª—É—á—à–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–≥–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º regex –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–º–µ–Ω—ã —Ç–µ–≥–∞
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `update_user_tag` –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### 3. –§—É–Ω–∫—Ü–∏—è update_user_tag —Ä–∞–±–æ—Ç–∞–ª–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ –∏—Å–∫–ª—é—á–∞–ª—Å—è —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–µ–≥–∞.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –ë—ã–ª–æ:
existing = get_db().table("users").select("id").eq("user_tag", new_tag).execute()

# –°—Ç–∞–ª–æ:
existing = get_db().table("users").select("id").eq("user_tag", new_tag).neq("id", user_id).execute()
```

## –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

1. **mainbot/handlers/chat_commands.py**
   - `handle_change_tag_menu()` - —É–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
   - `handle_start_tag_change()` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   - `handle_select_tag()` - –¥–æ–±–∞–≤–ª–µ–Ω parse_mode –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   - `handle_back_to_profile()` - —É–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
   - `handle_random_tag()` - –¥–æ–±–∞–≤–ª–µ–Ω parse_mode
   - `process_new_tag()` - –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

2. **mainbot/database/db.py**
   - `update_user_tag()` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–µ–≥–∞

## –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

### –ß–µ—Ä–µ–∑ –ø—Ä–æ—Ñ–∏–ª—å:
1. –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –∫–æ–º–∞–Ω–¥–æ–π `/me` –∏–ª–∏ –∫–Ω–æ–ø–∫–æ–π "üë§ –ü—Ä–æ—Ñ–∏–ª—å"
2. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "üè∑ –°–º–µ–Ω–∏—Ç—å —Ç–µ–≥"
3. –í—ã–±—Ä–∞—Ç—å –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:
   - "‚úèÔ∏è –í–≤–µ—Å—Ç–∏ –Ω–æ–≤—ã–π —Ç–µ–≥" - –≤–≤–µ—Å—Ç–∏ —Ç–µ–≥ –≤—Ä—É—á–Ω—É—é
   - "üé≤ –°–ª—É—á–∞–π–Ω—ã–π —Ç–µ–≥" - –≤—ã–±—Ä–∞—Ç—å –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤

### –ß–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É:
```
/changetag #–Ω–æ–≤—ã–π_—Ç–µ–≥
```

## –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Ç–µ–≥–æ–≤:

- –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Å–∏–º–≤–æ–ª–∞ `#`
- –î–ª–∏–Ω–∞: 3-20 —Å–∏–º–≤–æ–ª–æ–≤
- –¢–æ–ª—å–∫–æ –±—É–∫–≤—ã (a-z, A-Z), —Ü–∏—Ñ—Ä—ã (0-9) –∏ —Å–∏–º–≤–æ–ª –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è `_`
- –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º

## –ü—Ä–∏–º–µ—Ä—ã –≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–µ–≥–æ–≤:

- `#irl_boss`
- `#worker1`
- `#pro_trader`
- `#top_king`
- `#mega99`

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:

–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è —Ç–µ–ø–µ—Ä—å –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:
- –í—Ö–æ–¥ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–º–µ–Ω—ã —Ç–µ–≥–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–µ–≥–∞
- –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–≥–∞
- –í—Å–µ –æ—à–∏–±–∫–∏ —Å –ø–æ–ª–Ω—ã–º traceback

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –≤ –ª–æ–≥–∞—Ö –±–æ—Ç–∞.
