<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IRL Team ‚Ä¢ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-secondary-bg-color: #f4f4f5;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #8e8e93;
            --tg-theme-link-color: #2AABEE;
            --tg-theme-button-color: #2AABEE;
            --tg-theme-button-text-color: #ffffff;
        }
        :root {
            --bg: var(--tg-theme-bg-color);
            --bg2: var(--tg-theme-secondary-bg-color);
            --text: var(--tg-theme-text-color);
            --hint: var(--tg-theme-hint-color);
            --accent: var(--tg-theme-button-color);
            --accent-light: rgba(42, 171, 238, 0.12);
            --btn-text: var(--tg-theme-button-text-color);
            --green: #34C759;
            --green-light: rgba(52, 199, 89, 0.12);
            --orange: #FF9500;
            --orange-light: rgba(255, 149, 0, 0.12);
            --red: #FF3B30;
            --purple: #AF52DE;
            --radius: 16px;
            --radius-sm: 12px;
            --shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif; background: var(--bg2); color: var(--text); min-height: 100vh; padding-bottom: 40px; }
</style>
</head>
<body>
    <div class="header" id="header"></div>
    <div class="tabs" id="tabs"></div>
    <div id="overview" class="tab-content active"></div>
    <div id="leaderboard" class="tab-content"></div>
    <div id="calendar" class="tab-content"></div>
    <div id="achievements" class="tab-content"></div>
    <div class="loader" id="loader"><div class="spinner"></div><div class="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div></div>
</body>
</html>

<style>
    /* Header */
    .header { background: var(--bg); padding: 16px 20px; display: flex; align-items: center; gap: 14px; border-bottom: 1px solid var(--bg2); }
    .header-avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), #1E96D1); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; }
    .header-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .header-avatar svg { width: 24px; height: 24px; color: #fff; }
    .header-info { flex: 1; min-width: 0; }
    .header-title { font-size: 18px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .header-sub { font-size: 13px; color: var(--hint); margin-top: 2px; display: flex; align-items: center; gap: 6px; }
    .header-badge { background: var(--green-light); color: var(--green); padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
    
    /* Tabs */
    .tabs { display: flex; background: var(--bg); padding: 12px 16px; gap: 8px; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--bg2); overflow-x: auto; scrollbar-width: none; }
    .tabs::-webkit-scrollbar { display: none; }
    .tab { padding: 10px 16px; font-size: 14px; font-weight: 500; color: var(--hint); background: var(--bg2); border-radius: 12px; cursor: pointer; white-space: nowrap; transition: all 0.2s; border: none; display: flex; align-items: center; gap: 8px; }
    .tab svg { width: 18px; height: 18px; }
    .tab.active { background: var(--accent); color: #fff; }
    .tab.active svg { color: #fff; }
    
    /* Stats Card */
    .stats-card { background: linear-gradient(135deg, var(--accent) 0%, #1E96D1 100%); margin: 16px; border-radius: var(--radius); padding: 24px 20px; color: #fff; position: relative; overflow: hidden; box-shadow: 0 4px 20px rgba(42, 171, 238, 0.3); }
    .stats-card::before { content: ''; position: absolute; top: -60%; right: -20%; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%; }
    .stats-card::after { content: ''; position: absolute; bottom: -40%; left: -10%; width: 150px; height: 150px; background: rgba(255,255,255,0.05); border-radius: 50%; }
    .stats-label { font-size: 14px; opacity: 0.9; display: flex; align-items: center; gap: 8px; }
    .stats-label svg { width: 18px; height: 18px; }
    .stats-amount { font-size: 40px; font-weight: 700; margin: 8px 0; letter-spacing: -1px; }
    .stats-row { display: flex; gap: 16px; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); }
    .stats-item { flex: 1; text-align: center; }
    .stats-item-val { font-size: 20px; font-weight: 600; }
    .stats-item-lbl { font-size: 12px; opacity: 0.8; margin-top: 4px; }
</style>

<style>
    /* Cards */
    .section { padding: 0 16px; }
    .section-title { font-size: 13px; color: var(--hint); text-transform: uppercase; letter-spacing: 0.5px; margin: 24px 0 12px 4px; font-weight: 600; }
    .card { background: var(--bg); border-radius: var(--radius); overflow: hidden; margin-bottom: 16px; box-shadow: var(--shadow); }
    .card-header { padding: 16px; border-bottom: 1px solid var(--bg2); display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .card-title svg { width: 20px; height: 20px; color: var(--accent); }
    
    /* Stat Grid */
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; }
    .stat-box { padding: 20px 16px; text-align: center; border-bottom: 1px solid var(--bg2); position: relative; }
    .stat-box:nth-child(odd) { border-right: 1px solid var(--bg2); }
    .stat-box:nth-last-child(-n+2) { border-bottom: none; }
    .stat-box-icon { width: 44px; height: 44px; border-radius: 12px; margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; }
    .stat-box-icon svg { width: 22px; height: 22px; }
    .stat-box-icon.blue { background: var(--accent-light); color: var(--accent); }
    .stat-box-icon.green { background: var(--green-light); color: var(--green); }
    .stat-box-icon.orange { background: var(--orange-light); color: var(--orange); }
    .stat-box-icon.purple { background: rgba(175, 82, 222, 0.12); color: var(--purple); }
    .stat-box-val { font-size: 24px; font-weight: 700; color: var(--text); }
    .stat-box-lbl { font-size: 13px; color: var(--hint); margin-top: 4px; }
    
    /* Chart Container */
    .chart-container { padding: 20px 16px; height: 220px; position: relative; }
    .chart-legend { display: flex; justify-content: center; gap: 20px; padding: 0 16px 16px; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--hint); }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
</style>

<style>
    /* Leaderboard */
    .list { background: var(--bg); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); }
    .list-item { display: flex; align-items: center; padding: 14px 16px; gap: 12px; transition: background 0.15s; }
    .list-item:active { background: var(--bg2); }
    .list-item:not(:last-child) { border-bottom: 1px solid var(--bg2); }
    .rank-badge { width: 32px; height: 32px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; background: var(--bg2); color: var(--hint); flex-shrink: 0; }
    .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); color: #fff; box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4); }
    .rank-2 { background: linear-gradient(135deg, #E8E8E8, #C0C0C0); color: #666; }
    .rank-3 { background: linear-gradient(135deg, #CD7F32, #B87333); color: #fff; }
    .avatar { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), #1E96D1); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 600; font-size: 16px; overflow: hidden; flex-shrink: 0; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .user-info { flex: 1; min-width: 0; }
    .user-name { font-size: 16px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-sub { font-size: 14px; color: var(--green); font-weight: 600; margin-top: 2px; }
    .user-badge { font-size: 11px; background: var(--accent-light); color: var(--accent); padding: 2px 8px; border-radius: 8px; margin-left: 8px; }
    
    /* Filter */
    .filter-select { background: var(--bg2); border: none; color: var(--text); font-size: 14px; font-weight: 500; padding: 8px 12px; border-radius: 10px; cursor: pointer; appearance: none; -webkit-appearance: none; padding-right: 28px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238e8e93' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; }
</style>

<style>
    /* Calendar */
    .cal-card { background: var(--bg); border-radius: var(--radius); margin: 16px; overflow: hidden; box-shadow: var(--shadow); }
    .cal-nav { display: flex; justify-content: space-between; align-items: center; padding: 16px; }
    .cal-btn { background: var(--bg2); border: none; color: var(--text); cursor: pointer; width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; transition: background 0.15s; }
    .cal-btn:active { background: var(--accent-light); }
    .cal-btn svg { width: 20px; height: 20px; }
    .cal-title { font-weight: 600; font-size: 17px; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; padding: 0 16px 20px; }
    .cal-head { text-align: center; font-size: 12px; color: var(--hint); padding: 8px 0; font-weight: 500; }
    .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 10px; font-size: 14px; font-weight: 500; background: var(--bg2); transition: all 0.2s; }
    .cal-day.empty { background: transparent; }
    .cal-day.profit { background: var(--accent-light); color: var(--accent); font-weight: 600; }
    .cal-day.profit.high { background: var(--accent); color: white; }
    .cal-day.today { box-shadow: inset 0 0 0 2px var(--accent); }
    
    /* Streak Card */
    .streak-card { display: flex; align-items: center; gap: 16px; padding: 20px; background: linear-gradient(135deg, #FF9500 0%, #FF6B00 100%); border-radius: var(--radius); margin: 16px; color: #fff; box-shadow: 0 4px 20px rgba(255, 149, 0, 0.3); }
    .streak-icon { width: 56px; height: 56px; background: rgba(255,255,255,0.2); border-radius: 16px; display: flex; align-items: center; justify-content: center; }
    .streak-icon svg { width: 32px; height: 32px; }
    .streak-content { flex: 1; }
    .streak-val { font-size: 28px; font-weight: 700; }
    .streak-lbl { font-size: 14px; opacity: 0.9; margin-top: 2px; }
</style>

<style>
    /* Achievements */
    .ach-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 0 16px; }
    .ach-card { background: var(--bg); border-radius: var(--radius); padding: 16px; text-align: center; box-shadow: var(--shadow); }
    .ach-card.locked { opacity: 0.6; }
    .ach-icon { width: 56px; height: 56px; border-radius: 16px; margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; }
    .ach-icon.done { background: linear-gradient(135deg, var(--accent), #1E96D1); }
    .ach-icon.locked { background: var(--bg2); }
    .ach-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .ach-desc { font-size: 12px; color: var(--hint); margin-bottom: 10px; }
    .ach-progress { height: 6px; background: var(--bg2); border-radius: 3px; overflow: hidden; }
    .ach-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #1E96D1); border-radius: 3px; transition: width 0.5s ease; }
    .ach-status { font-size: 11px; font-weight: 600; margin-top: 8px; }
    .ach-status.done { color: var(--green); }
    .ach-status.progress { color: var(--hint); }
    
    /* Summary Card */
    .summary-card { background: var(--bg); border-radius: var(--radius); margin: 16px; padding: 20px; display: flex; align-items: center; gap: 16px; box-shadow: var(--shadow); }
    .summary-icon { width: 56px; height: 56px; background: linear-gradient(135deg, var(--accent), #1E96D1); border-radius: 16px; display: flex; align-items: center; justify-content: center; }
    .summary-icon svg { width: 28px; height: 28px; color: #fff; }
    .summary-content { flex: 1; }
    .summary-val { font-size: 28px; font-weight: 700; }
    .summary-lbl { font-size: 14px; color: var(--hint); margin-top: 2px; }
    
    /* Tab Content */
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Loader */
    .loader { position: fixed; inset: 0; background: var(--bg); z-index: 200; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 16px; }
    .loader.hidden { display: none; }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--bg2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loader-text { font-size: 15px; color: var(--hint); }
    
    /* Empty State */
    .empty { text-align: center; padding: 60px 20px; }
    .empty-icon { width: 80px; height: 80px; margin: 0 auto 20px; background: var(--bg2); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .empty-icon svg { width: 40px; height: 40px; color: var(--hint); }
    .empty-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .empty-text { font-size: 14px; color: var(--hint); max-width: 260px; margin: 0 auto; }
</style>

<script>
    // SVG Icons
    const ICONS = {
        chart: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>',
        trophy: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>',
        calendar: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg>',
        target: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
        fire: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>',
        wallet: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>',
        users: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
        trending: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>',
        star: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
        chevronLeft: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>',
        chevronRight: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>',
        clock: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
        zap: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>'
    };
    
    // Config
    const SUPABASE_URL = 'https://aoyctqguudkdwgixlmvr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFveWN0cWd1dWRrZHdnaXhsbXZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMjU0MDIsImV4cCI6MjA4MTkwMTQwMn0.AOpN7RldZ29C9fP41eMmAb66Jy9bnYwez3FT9V4qV5U';
    
    let db, tg, userId, userPhoto, userName;
    try { db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) {}
    try { 
        tg = window.Telegram?.WebApp; 
        if(tg) { 
            tg.ready(); 
            tg.expand(); 
            userId = tg.initDataUnsafe?.user?.id;
            userPhoto = tg.initDataUnsafe?.user?.photo_url;
            userName = tg.initDataUnsafe?.user?.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        } 
    } catch(e) {}
    
    let allProfits = [], allUsers = [], userProfits = [], currentUser = null;
    let calMonth = new Date();
    let lbFilter = 'all';
    let weekChart = null;
</script>

<script>
    // Helpers
    const fmt = n => new Intl.NumberFormat('ru-RU').format(Math.round(n)) + ' ‚ÇΩ';
    const fmtShort = n => {
        if (n >= 1000000) return (n/1000000).toFixed(1) + 'M ‚ÇΩ';
        if (n >= 1000) return (n/1000).toFixed(1) + 'K ‚ÇΩ';
        return Math.round(n) + ' ‚ÇΩ';
    };
    const sum = arr => arr.reduce((a,b) => a + (parseFloat(b.net_profit)||0), 0);
    const isSameDay = (d1, d2) => d1.getDate() === d2.getDate() && d1.getMonth() === d2.getMonth() && d1.getFullYear() === d2.getFullYear();
    const getPlural = (n, forms) => {
        const n10 = n % 10, n100 = n % 100;
        if(n10 === 1 && n100 !== 11) return forms[0];
        if(n10 >= 2 && n10 <= 4 && (n100 < 10 || n100 >= 20)) return forms[1];
        return forms[2];
    };
    
    const AVATAR_COLORS = ['#FF6B6B','#4ECDC4','#45B7D1','#96CEB4','#FFEAA7','#DDA0DD','#98D8C8','#F7DC6F','#BB8FCE','#85C1E9'];
    const getAvatarColor = id => AVATAR_COLORS[Math.abs(parseInt(id) || 0) % AVATAR_COLORS.length];
    const getInitials = name => (name || 'U').split(' ').map(w => w[0]).slice(0,2).join('').toUpperCase();
    
    const ACHIEVEMENTS = [
        { id: 'first', title: '–ü–µ—Ä–≤—ã–π —Å—Ç–∞—Ä—Ç', desc: '–ü–µ—Ä–≤—ã–π –ø—Ä–æ—Ñ–∏—Ç', target: 1, icon: 'üöÄ' },
        { id: 'p10', title: '–î–µ—Å—è—Ç–∫–∞', desc: '10 –ø—Ä–æ—Ñ–∏—Ç–æ–≤', target: 10, icon: 'üéØ' },
        { id: 'p50', title: '–ü—Ä–æ—Ñ–∏', desc: '50 –ø—Ä–æ—Ñ–∏—Ç–æ–≤', target: 50, icon: 'üí™' },
        { id: 'p100', title: '–ú–∞—Å—Ç–µ—Ä', desc: '100 –ø—Ä–æ—Ñ–∏—Ç–æ–≤', target: 100, icon: 'üëë' },
        { id: 'm10k', title: '–ö–∞–ø–∏—Ç–∞–ª', desc: '–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å 10K', target: 10000, isMoney: true, icon: 'üí∞' },
        { id: 'm50k', title: '–ò–Ω–≤–µ—Å—Ç–æ—Ä', desc: '–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å 50K', target: 50000, isMoney: true, icon: 'üíé' },
        { id: 'm100k', title: '–ë–æ–≥–∞—Ç–µ–π', desc: '–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å 100K', target: 100000, isMoney: true, icon: 'üèÜ' },
        { id: 's3', title: '–°–µ—Ä–∏—è', desc: '3 –¥–Ω—è –ø–æ–¥—Ä—è–¥', target: 3, isStreak: true, icon: 'üî•' },
        { id: 's7', title: '–ù–µ–¥–µ–ª—è –æ–≥–Ω—è', desc: '7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥', target: 7, isStreak: true, icon: '‚ö°' },
        { id: 's30', title: '–ú–µ—Å—è—Ü —Å–∏–ª—ã', desc: '30 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥', target: 30, isStreak: true, icon: 'üåü' }
    ];
    
    // Init tabs
    document.getElementById('tabs').innerHTML = `
        <div class="tab active" data-tab="overview">${ICONS.chart} –û–±–∑–æ—Ä</div>
        <div class="tab" data-tab="leaderboard">${ICONS.trophy} –¢–æ–ø</div>
        <div class="tab" data-tab="calendar">${ICONS.calendar} –ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
        <div class="tab" data-tab="achievements">${ICONS.target} –ê—á–∏–≤–∫–∏</div>
    `;
    
    document.querySelectorAll('.tab').forEach(tab => {
        tab.onclick = () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
        };
    });
</script>

<script>
    async function load() {
        if (!db) { document.getElementById('loader').classList.add('hidden'); return; }
        
        const [pRes, uRes] = await Promise.all([
            db.from('profits').select('*').order('created_at', {ascending: false}),
            db.from('users').select('*').eq('status', 'active')
        ]);
        
        allProfits = pRes.data || [];
        allUsers = uRes.data || [];
        userProfits = userId ? allProfits.filter(p => p.worker_id == userId) : [];
        currentUser = userId ? allUsers.find(u => u.id == userId) : null;
        
        // Render header
        const avatarHtml = userPhoto 
            ? `<img src="${userPhoto}" alt="">` 
            : ICONS.users;
        const displayName = currentUser?.full_name || userName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        
        document.getElementById('header').innerHTML = `
            <div class="header-avatar">${avatarHtml}</div>
            <div class="header-info">
                <div class="header-title">${displayName}</div>
                <div class="header-sub">
                    <span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã</span>
                    <span class="header-badge">IRL Team</span>
                </div>
            </div>
        `;
        
        document.getElementById('loader').classList.add('hidden');
        renderAll();
    }
    
    function renderAll() { 
        renderOverview(); 
        renderLeaderboard(); 
        renderCalendar(); 
        renderAchievements(); 
    }
    
    function renderOverview() {
        const teamTotal = sum(allProfits);
        const todayProfits = allProfits.filter(p => isSameDay(new Date(p.created_at), new Date()));
        const teamToday = sum(todayProfits);
        const myTotal = sum(userProfits);
        const myToday = sum(userProfits.filter(p => isSameDay(new Date(p.created_at), new Date())));
        
        // Calculate rank
        const userMap = {};
        allProfits.forEach(p => userMap[p.worker_id] = (userMap[p.worker_id]||0) + (parseFloat(p.net_profit)||0));
        const rank = Object.entries(userMap).sort((a,b) => b[1]-a[1]).findIndex(x => x[0] == userId) + 1;
        
        // Week data for chart
        const days = ['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];
        const chartLabels = [];
        const chartData = [];
        const teamChartData = [];
        
        for(let i=6; i>=0; i--) {
            const d = new Date(); d.setDate(d.getDate() - i);
            chartLabels.push(days[d.getDay()]);
            chartData.push(sum(userProfits.filter(p => isSameDay(new Date(p.created_at), d))));
            teamChartData.push(sum(allProfits.filter(p => isSameDay(new Date(p.created_at), d))));
        }
        
        // Service breakdown for pie chart
        const serviceMap = {};
        userProfits.forEach(p => serviceMap[p.service_name] = (serviceMap[p.service_name]||0) + parseFloat(p.net_profit));
        const serviceData = Object.entries(serviceMap).sort((a,b) => b[1]-a[1]).slice(0, 5);
        
        document.getElementById('overview').innerHTML = `
            <div class="stats-card">
                <div class="stats-label">${ICONS.wallet} –ü—Ä–æ—Ñ–∏—Ç –∫–æ–º–∞–Ω–¥—ã</div>
                <div class="stats-amount">${fmt(teamTotal)}</div>
                <div class="stats-row">
                    <div class="stats-item">
                        <div class="stats-item-val">${fmtShort(teamToday)}</div>
                        <div class="stats-item-lbl">–°–µ–≥–æ–¥–Ω—è</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-item-val">${allUsers.length}</div>
                        <div class="stats-item-lbl">–í–æ—Ä–∫–µ—Ä–æ–≤</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-item-val">${allProfits.length}</div>
                        <div class="stats-item-lbl">–ü—Ä–æ—Ñ–∏—Ç–æ–≤</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">–ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                <div class="card">
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="stat-box-icon blue">${ICONS.wallet}</div>
                            <div class="stat-box-val">${fmtShort(myTotal)}</div>
                            <div class="stat-box-lbl">–í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-icon green">${ICONS.trending}</div>
                            <div class="stat-box-val">${userProfits.length}</div>
                            <div class="stat-box-lbl">–ü—Ä–æ—Ñ–∏—Ç–æ–≤</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-icon orange">${ICONS.clock}</div>
                            <div class="stat-box-val">${fmtShort(myToday)}</div>
                            <div class="stat-box-lbl">–°–µ–≥–æ–¥–Ω—è</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-icon purple">${ICONS.trophy}</div>
                            <div class="stat-box-val">#${rank || '‚Äî'}</div>
                            <div class="stat-box-lbl">–ü–æ–∑–∏—Ü–∏—è –≤ —Ç–æ–ø–µ</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">–î–∏–Ω–∞–º–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
                <div class="card">
                    <div class="chart-container">
                        <canvas id="weekChart"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item"><div class="legend-dot" style="background: var(--accent)"></div> –ú–æ–∏ –ø—Ä–æ—Ñ–∏—Ç—ã</div>
                        <div class="legend-item"><div class="legend-dot" style="background: var(--green)"></div> –ö–æ–º–∞–Ω–¥–∞</div>
                    </div>
                </div>
            </div>
            
            ${serviceData.length ? `
            <div class="section">
                <div class="section-title">–ü–æ —Å–µ—Ä–≤–∏—Å–∞–º</div>
                <div class="card">
                    <div class="chart-container" style="height: 200px;">
                        <canvas id="serviceChart"></canvas>
                    </div>
                </div>
            </div>` : ''}
        `;
        
        // Render charts
        setTimeout(() => {
            renderWeekChart(chartLabels, chartData, teamChartData);
            if (serviceData.length) renderServiceChart(serviceData);
        }, 100);
    }
</script>

<script>
    function renderWeekChart(labels, userData, teamData) {
        const ctx = document.getElementById('weekChart');
        if (!ctx) return;
        
        if (weekChart) weekChart.destroy();
        
        const maxTeam = Math.max(...teamData);
        const scaledTeam = teamData.map(v => maxTeam > 0 ? (v / maxTeam) * Math.max(...userData, 1) * 0.5 : 0);
        
        weekChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '–ú–æ–∏ –ø—Ä–æ—Ñ–∏—Ç—ã',
                    data: userData,
                    backgroundColor: 'rgba(42, 171, 238, 0.8)',
                    borderRadius: 8,
                    borderSkipped: false,
                }, {
                    label: '–ö–æ–º–∞–Ω–¥–∞',
                    data: teamData,
                    backgroundColor: 'rgba(52, 199, 89, 0.3)',
                    borderRadius: 8,
                    borderSkipped: false,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#8e8e93', font: { size: 12 } } },
                    y: { display: false }
                }
            }
        });
    }
    
    function renderServiceChart(data) {
        const ctx = document.getElementById('serviceChart');
        if (!ctx) return;
        
        const colors = ['#2AABEE', '#34C759', '#FF9500', '#AF52DE', '#FF3B30'];
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.map(d => d[0]),
                datasets: [{
                    data: data.map(d => d[1]),
                    backgroundColor: colors.slice(0, data.length),
                    borderWidth: 0,
                    spacing: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { 
                            boxWidth: 12, 
                            padding: 12,
                            font: { size: 12 },
                            color: '#8e8e93'
                        }
                    }
                }
            }
        });
    }
    
    function renderLeaderboard() {
        let data = allProfits;
        const now = new Date();
        
        if (lbFilter === 'month') data = data.filter(p => new Date(p.created_at).getMonth() === now.getMonth() && new Date(p.created_at).getFullYear() === now.getFullYear());
        else if (lbFilter === 'week') data = data.filter(p => new Date(p.created_at) >= new Date(now.getTime() - 7*24*60*60*1000));
        else if (lbFilter === 'day') data = data.filter(p => isSameDay(new Date(p.created_at), now));
        
        const totals = {};
        data.forEach(p => totals[p.worker_id] = (totals[p.worker_id]||0) + (parseFloat(p.net_profit)||0));
        const sorted = Object.entries(totals)
            .map(([id, val]) => ({ id, val, user: allUsers.find(u => u.id == id) }))
            .sort((a,b) => b.val - a.val)
            .slice(0, 20);
        
        const filterLabels = { all: '–í—Å—ë –≤—Ä–µ–º—è', month: '–ú–µ—Å—è—Ü', week: '–ù–µ–¥–µ–ª—è', day: '–°–µ–≥–æ–¥–Ω—è' };
        
        document.getElementById('leaderboard').innerHTML = `
            <div class="section" style="margin-top: 16px;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">${ICONS.trophy} –†–µ–π—Ç–∏–Ω–≥ –≤–æ—Ä–∫–µ—Ä–æ–≤</div>
                        <select class="filter-select" onchange="lbFilter=this.value;renderLeaderboard()">
                            ${Object.entries(filterLabels).map(([k,v]) => `<option value="${k}" ${lbFilter===k?'selected':''}>${v}</option>`).join('')}
                        </select>
                    </div>
                    ${sorted.length ? sorted.map((item, i) => {
                        const rankCls = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : '';
                        const name = item.user?.full_name || 'Worker';
                        const initials = getInitials(name);
                        const avatarBg = getAvatarColor(item.id);
                        const isMe = item.id == userId;
                        const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
                        return `<div class="list-item" style="${isMe ? 'background: var(--accent-light);' : ''}">
                            <div class="rank-badge ${rankCls}">${i+1}</div>
                            <div class="avatar" style="background: linear-gradient(135deg, ${avatarBg}, ${avatarBg}dd)">${initials}</div>
                            <div class="user-info">
                                <div class="user-name">${name} ${medal}${isMe ? '<span class="user-badge">–í—ã</span>' : ''}</div>
                                <div class="user-sub">+${fmt(item.val)}</div>
                            </div>
                        </div>`;
                    }).join('') : '<div class="empty"><div class="empty-icon">' + ICONS.users + '</div><div class="empty-title">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div><div class="empty-text">–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–µ—Ç –ø—Ä–æ—Ñ–∏—Ç–æ–≤</div></div>'}
                </div>
            </div>
        `;
    }
</script>

<script>
    function renderCalendar() {
        const year = calMonth.getFullYear();
        const month = calMonth.getMonth();
        const firstDay = new Date(year, month, 1).getDay() || 7;
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const monthNames = ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
        
        const pMap = {};
        userProfits.forEach(p => {
            const d = new Date(p.created_at);
            if(d.getMonth() === month && d.getFullYear() === year) {
                pMap[d.getDate()] = (pMap[d.getDate()]||0) + (parseFloat(p.net_profit)||0);
            }
        });
        
        const streak = calculateStreak();
        const monthTotal = sum(userProfits.filter(p => {
            const d = new Date(p.created_at);
            return d.getMonth() === month && d.getFullYear() === year;
        }));
        
        let daysHtml = '';
        for(let i=1; i<firstDay; i++) daysHtml += '<div class="cal-day empty"></div>';
        for(let d=1; d<=daysInMonth; d++) {
            const val = pMap[d] || 0;
            let cls = 'cal-day';
            if(val > 0) cls += val > 5000 ? ' profit high' : ' profit';
            if(isSameDay(new Date(year, month, d), new Date())) cls += ' today';
            daysHtml += `<div class="${cls}" title="${val > 0 ? fmt(val) : ''}">${d}</div>`;
        }
        
        document.getElementById('calendar').innerHTML = `
            <div class="streak-card">
                <div class="streak-icon">${ICONS.fire}</div>
                <div class="streak-content">
                    <div class="streak-val">${streak} ${getPlural(streak, ['–¥–µ–Ω—å','–¥–Ω—è','–¥–Ω–µ–π'])}</div>
                    <div class="streak-lbl">–¢–µ–∫—É—â–∞—è —Å–µ—Ä–∏—è –ø—Ä–æ—Ñ–∏—Ç–æ–≤</div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon">${ICONS.calendar}</div>
                <div class="summary-content">
                    <div class="summary-val">${fmt(monthTotal)}</div>
                    <div class="summary-lbl">–ü—Ä–æ—Ñ–∏—Ç –∑–∞ ${monthNames[month].toLowerCase()}</div>
                </div>
            </div>
            
            <div class="cal-card">
                <div class="cal-nav">
                    <button class="cal-btn" onclick="calMonth.setMonth(calMonth.getMonth()-1);renderCalendar()">${ICONS.chevronLeft}</button>
                    <div class="cal-title">${monthNames[month]} ${year}</div>
                    <button class="cal-btn" onclick="calMonth.setMonth(calMonth.getMonth()+1);renderCalendar()">${ICONS.chevronRight}</button>
                </div>
                <div class="cal-grid">
                    <div class="cal-head">–ü–Ω</div><div class="cal-head">–í—Ç</div><div class="cal-head">–°—Ä</div><div class="cal-head">–ß—Ç</div>
                    <div class="cal-head">–ü—Ç</div><div class="cal-head">–°–±</div><div class="cal-head">–í—Å</div>
                    ${daysHtml}
                </div>
            </div>
        `;
    }
    
    function renderAchievements() {
        const totalMoney = sum(userProfits);
        const totalCount = userProfits.length;
        const streak = calculateStreak();
        let unlockedCount = 0;
        
        const achHtml = ACHIEVEMENTS.map(ach => {
            let current = ach.isMoney ? totalMoney : ach.isStreak ? streak : totalCount;
            const progress = Math.min((current / ach.target) * 100, 100);
            const isDone = progress >= 100;
            if(isDone) unlockedCount++;
            
            return `<div class="ach-card ${isDone ? '' : 'locked'}">
                <div class="ach-icon ${isDone ? 'done' : 'locked'}">${ach.icon}</div>
                <div class="ach-title">${ach.title}</div>
                <div class="ach-desc">${ach.desc}</div>
                <div class="ach-progress"><div class="ach-fill" style="width:${progress}%"></div></div>
                <div class="ach-status ${isDone ? 'done' : 'progress'}">${isDone ? '‚úì –ü–æ–ª—É—á–µ–Ω–æ' : Math.floor(current) + ' / ' + ach.target}</div>
            </div>`;
        }).join('');
        
        document.getElementById('achievements').innerHTML = `
            <div class="summary-card" style="margin-top: 16px;">
                <div class="summary-icon">${ICONS.star}</div>
                <div class="summary-content">
                    <div class="summary-val">${unlockedCount} / ${ACHIEVEMENTS.length}</div>
                    <div class="summary-lbl">–î–æ—Å—Ç–∏–∂–µ–Ω–∏–π —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
                </div>
            </div>
            <div class="section">
                <div class="section-title">–í—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
            </div>
            <div class="ach-grid">${achHtml}</div>
        `;
    }
    
    function calculateStreak() {
        const uniqueDays = [...new Set(userProfits.map(p => new Date(p.created_at).toDateString()))].map(s => new Date(s)).sort((a,b)=>b-a);
        if(!uniqueDays.length) return 0;
        let streak = 0, checkDate = new Date();
        checkDate.setHours(0,0,0,0);
        if(!isSameDay(uniqueDays[0], checkDate)) { 
            checkDate.setDate(checkDate.getDate() - 1); 
            if(!isSameDay(uniqueDays[0], checkDate)) return 0; 
        }
        for(const day of uniqueDays) { 
            if(isSameDay(day, checkDate)) { 
                streak++; 
                checkDate.setDate(checkDate.getDate() - 1); 
            } else break; 
        }
        return streak;
    }
    
    load();
</script>